<% layout('layouts/boilerplate') -%>
<body>
  <div class="row">
    <div class="col-8 offset-2">
      <br /><br />
      <h3 id="cmp">Edit your Complaint:</h3>

      <form method="POST" action="/listings/<%= listing._id %>?_method=PUT" enctype="multipart/form-data">
        <div class="mb-3">
          <label id="cmp" for="title" class="form-label">Title</label>
          <input
            name="listing[title]"
            value="<%= listing.title %>"
            type="text"
            class="form-control"
            required
          />
        </div>

        <div class="mb-3">
          <label id="cmp" for="description" class="form-label">Description</label>
          <textarea
            class="form-control"
            name="listing[description]"
            required
          ><%= listing.description %></textarea>
        </div>

        <div class="mb-3">
        <label id="cmp" class="form-label">Current Image:</label><br>
        <img src="<%= listing.image %>" alt="Current Image" id="image-preview" class="img-fluid mb-2" style="max-height: 200px; border-radius: 12px;">
          <br>
        <label id="cmp" for="image-input" class="form-label">Upload New Image (Optional):</label>
        <input name="listing[image]" type="file" class="form-control" id="image-input" />
        </div>

        <div class="row">
          <div class="mb-3 col-md-4">
            <label id="cmp" for="date" class="form-label">Date</label>
            <input
              name="listing[date]"
              value="<%= listing.date.toISOString().split('T')[0] %>"
              type="date"
              class="form-control"
            />
          </div>

          <div class="mb-3 col-md-8">
            <label id="cmp" for="city" class="form-label">City</label>
            <input
              name="listing[city]"
              value="<%= listing.city %>"
              type="text"
              class="form-control"
            />
          </div>
        </div>

        <div class="mb-3">
            <label for="location-input" id="cmp" class="form-label">Address</label>
            <div class="input-group">
            <input name="listing[address]" type="text" class="form-control" id="location-input" value="<%= listing.address || '' %>" required />
            <button class="btn btn-outline-secondary" type="button" id="get-location-btn">Get My Location</button>
            </div>
        </div>
        <input type="hidden" name="listing[location][type]" value="Point" />
        <input type="hidden" name="listing[location][coordinates][]" id="lng-input" value="<%= (listing.location && listing.location.coordinates && listing.location.coordinates[0]) || '' %>" />
        <input type="hidden" name="listing[location][coordinates][]" id="lat-input" value="<%= (listing.location && listing.location.coordinates && listing.location.coordinates[1]) || '' %>" />

    <div class="map-wrapper mb-3">
      <div id="map"></div>
      <div class="map-spinner" id="map-spinner">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Loading map...</span>
        </div>
      </div>
      <div class="alert alert-danger map-error" id="map-error" role="alert">
        Could not load the map. Please check your network or try again later.
      </div>
    </div>
        <button class="btn btn-dark add-btn mb-3">Save Changes</button>
        </div>
        
      </form>
    </div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationInput = document.getElementById('location-input');
    const getLocationBtn = document.getElementById('get-location-btn');
    const mapContainer = document.getElementById('map');
    
    const map = L.map(mapContainer).setView([18.5204, 73.8567], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let marker = L.marker([18.5204, 73.8567]).addTo(map)
        .bindPopup('Your selected location.').openPopup();

    // âœ… This function now includes the reverse geocoding API call
    function updateLocation(lat, lng) {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 15);
        document.getElementById('lat-input').value = lat;
        document.getElementById('lng-input').value = lng;
        
        // Show a loading message while we fetch the address
        locationInput.value = "Fetching address...";

        // The Nominatim API URL
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    // Update the input field with the address
                    locationInput.value = data.display_name;
                } else {
                    // Fallback to coordinates if no address is found
                    locationInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            })
            .catch(error => {
                console.error('Error fetching address:', error);
                locationInput.value = "Could not fetch address.";
            });
    }

    map.on('click', function(e) {
        updateLocation(e.latlng.lat, e.latlng.lng);
    });

  getLocationBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          updateLocation(position.coords.latitude, position.coords.longitude);
        },
        function(error) {
          console.warn('Geolocation error:', error);
          const mapError = document.getElementById('map-error');
          mapError.textContent = 'Could not get your location. Please allow location access or enter address manually.';
          mapError.style.display = 'block';
          setTimeout(() => mapError.style.display = 'none', 6000);
        }
      );
    } else {
      alert('Geolocation is not supported by your browser.');
    }
  });

  // Spinner control and tile load handling
  const mapSpinner = document.getElementById('map-spinner');
  const mapError = document.getElementById('map-error');
  function showSpinner() { mapSpinner.style.display = 'block'; }
  function hideSpinner() { mapSpinner.style.display = 'none'; }

  // Show spinner while tiles load
  showSpinner();
  map.on('load', function() {
    hideSpinner();
  });
  map.on('tileload', function() {
    hideSpinner();
  });
  map.on('tileerror', function(err) {
    console.error('Tile load error:', err);
    hideSpinner();
    mapError.textContent = 'Map tiles failed to load. Check your network or try again later.';
    mapError.style.display = 'block';
  });
});
</script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('image-input');
      const imagePreview = document.getElementById('image-preview');

      if (fileInput && imagePreview) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          
          if (file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
              imagePreview.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
          }
        });
      }
    });
  </script>
</body>