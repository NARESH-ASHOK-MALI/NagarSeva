<% layout('layouts/boilerplate') -%>
<div class="admin-dashboard">
  <div class="admin-header">
    <h1 class="admin-title">My Dashboard</h1>
    <p class="admin-subtitle">View and manage your registered complaints</p>
  </div>
  
  <div class="dashboard-stats">
    <div class="stat-card">
      <i class="fas fa-file-alt"></i>
      <div class="stat-content">
        <h3><%= userComplaints.length %></h3>
        <p>Total Complaints</p>
      </div>
    </div>
    <div class="stat-card">
      <i class="fas fa-check-circle"></i>
      <div class="stat-content">
        <h3><%= userComplaints.filter(c => c.tracking.length > 0 && c.tracking[c.tracking.length - 1].status === 'Resolved').length %></h3>
        <p>Resolved</p>
      </div>
    </div>
    <div class="stat-card">
      <i class="fas fa-clock"></i>
      <div class="stat-content">
        <h3><%= userComplaints.filter(c => c.tracking.length === 0 || c.tracking[c.tracking.length - 1].status !== 'Resolved').length %></h3>
        <p>In Progress</p>
      </div>
    </div>
  </div>

  <div class="complaints-section">
    <h2 class="section-title">My Complaints</h2>
    <% if (userComplaints.length === 0) { %>
      <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3>No complaints yet</h3>
        <p>You haven't registered any complaints.</p>
        <a href="/listings/new" class="btn btn-primary mt-3">Register a Complaint</a>
      </div>
    <% } else { %>
      <div class="complaints-grid">
        <% userComplaints.forEach(function(item){ %>
          <div class="complaint-card">
            <div class="complaint-image">
              <img src="<%= item.image %>" alt="<%= item.title %>" />
            </div>
            <div class="complaint-content">
              <h4><a href="/listings/<%= item._id %>"><%= item.title %></a></h4>
              <div class="complaint-meta">
                <span class="meta-item"><i class="fas fa-map-marker-alt"></i> <%= item.city %></span>
                <span class="meta-item"><i class="fas fa-calendar"></i> <%= item.date.toLocaleDateString() %></span>
              </div>
              <div class="complaint-status">
                <% 
                  let currentStatus = 'Pending Verification';
                  let statusClass = 'status-pending';
                  if (item.tracking && item.tracking.length > 0) {
                    currentStatus = item.tracking[item.tracking.length - 1].status;
                    switch(currentStatus) {
                      case 'Verified':
                        statusClass = 'status-verified';
                        break;
                      case 'Assigned to Authority':
                        statusClass = 'status-assigned';
                        break;
                      case 'Work in Progress':
                        statusClass = 'status-progress';
                        break;
                      case 'Resolved':
                        statusClass = 'status-resolved';
                        break;
                      case 'Rejected':
                        statusClass = 'status-rejected';
                        break;
                      default:
                        statusClass = 'status-pending';
                    }
                  }
                %>
                <span class="status-badge <%= statusClass %>">
                  <i class="fas fa-circle"></i> <%= currentStatus %>
                </span>
              </div>
              <% if (item.assignedAuthority) { %>
                <div class="authority-info">
                  <i class="fas fa-building"></i> <strong>Assigned to:</strong> <%= item.assignedAuthority %>
                </div>
              <% } %>
              <div class="complaint-actions mt-3">
                <a href="/listings/<%= item._id %>" class="btn btn-sm btn-primary">View Details</a>
                <% if (!item.tracking || item.tracking.length === 0 || item.tracking[item.tracking.length - 1].status === 'Pending Verification') { %>
                  <a href="/listings/<%= item._id %>/edit" class="btn btn-sm btn-warning">Edit</a>
                  <form action="/listings/<%= item._id %>?_method=DELETE" method="POST" style="display:inline;">
                    <button class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this complaint?')">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<style>
  .complaint-status {
    margin: 10px 0;
  }
  
  .status-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  
  .status-pending {
    background-color: rgba(255, 193, 7, 0.2);
    color: #ffc107;
  }
  
  .status-verified {
    background-color: rgba(0, 123, 255, 0.2);
    color: #007bff;
  }
  
  .status-assigned {
    background-color: rgba(108, 117, 125, 0.2);
    color: #6c757d;
  }
  
  .status-progress {
    background-color: rgba(23, 162, 184, 0.2);
    color: #17a2b8;
  }
  
  .status-resolved {
    background-color: rgba(40, 167, 69, 0.2);
    color: #28a745;
  }
  
  .status-rejected {
    background-color: rgba(220, 53, 69, 0.2);
    color: #dc3545;
  }
  
  .authority-info {
    margin: 10px 0;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
    font-size: 0.9rem;
  }
  
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    backdrop-filter: blur(10px);
  }
  
  .empty-state i {
    font-size: 4rem;
    color: rgba(255, 255, 255, 0.3);
    margin-bottom: 20px;
  }
  
  .empty-state h3 {
    color: white;
    margin-bottom: 10px;
  }
  
  .empty-state p {
    color: rgba(255, 255, 255, 0.7);
  }
</style>
